---
title: 'AnÃ¡lise'
format:
  html:
    toc: true
    html-math-method: katex
    css: styles.css
cache: true
---

```{r}
#| echo: true
#| warning: false

library(tidyverse)
library(ggplot2)
library(plotly)
library(gridExtra)
```

```{r}
#| code-fold: true
#| code-summary: "Visualizar cÃ³digo"
#| warning: false

# dados processados sobre absenteismo
df_absenteismo = read.csv('absenteismo_processed.csv')
# dados processados sobre alertas no whatsapp
df_whatsapp = read.csv('whatsapp_processed.csv')
```

```{r}
#| code-fold: true
#| code-summary: 'CÃ³digo'
#| warning: false
#| fig-width: 14
#| fig-height: 10
#| out-width: '100%'

# calcular os totais e a taxa de absenteÃ­smo
df_totais = df_absenteismo |> 
  group_by(periodo) |> 
  summarise(Faltas = sum(faltas, na.rm = TRUE),
            Agendamentos = sum(agendamentos, na.rm = TRUE),
            TaxaAbsenteismo = (sum(Faltas) / sum(Agendamentos)) * 100,
            .groups = 'drop')

# calcular o fator de escala para a linha
max_quantidade = max(df_totais$Faltas, df_totais$Agendamentos, na.rm = TRUE)
fator_escala = max_quantidade / 100

# contruindo o grafico com os tres indicadores
df_totais |> 
  pivot_longer(
    cols = c(Faltas, Agendamentos),
    names_to = 'Tipo',
    values_to = 'Quantidade') |> 
  ggplot(aes(x = periodo)) +
  geom_bar(aes(y = Quantidade, fill = Tipo),
           stat = 'identity', position = 'dodge', alpha = 0.8) +
  geom_text(aes(y = Quantidade/2, label = ifelse(Tipo == 'Faltas', Quantidade, ''), 
                group = Tipo),position = position_dodge(width = 0.9),
            color = 'white', size = 3.5, fontface = 'bold',
            show.legend = FALSE) +
  geom_text(aes(y = Quantidade, label = ifelse(Tipo == 'Agendamentos', Quantidade, ''), group = Tipo),
            position = position_dodge(width = 0.9),
            vjust = -0.5, size = 3.5, fontface = 'bold', color = '#3BA9DB',
            show.legend = FALSE) +
  
  # Linha para a taxa de absenteÃ­smo
  geom_line(aes(y = TaxaAbsenteismo * fator_escala, group = 1), 
            color = '#2c5282', size = 1.5, alpha = 0.8) +
  geom_point(aes(y = TaxaAbsenteismo * fator_escala), 
             color = '#2c5282', size = 3) +
  geom_text(aes(y = TaxaAbsenteismo * fator_escala, 
                label = paste0(round(TaxaAbsenteismo, 1), '%')),
            vjust = -1, size = 3.5, color = '#2c5282', fontface = 'bold') +
  scale_y_continuous(
    name = '',
    sec.axis = sec_axis(~ . / fator_escala, 
                        name = '',
                        labels = function(x) paste0(round(x, 2), '%'))
  ) +
  labs(title = '', x = '', fill = '') +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.y.left = element_text(color = 'black'),
    axis.text.y.left = element_text(color = 'black'),
    axis.title.y.right = element_text(color = 'black'),
    axis.text.y.right = element_text(color = 'black'),
    panel.grid.major.y = element_line(color = 'gray80'),
    panel.grid.minor.y = element_blank(),
    legend.position = 'top'
  ) +
  scale_fill_manual(values = c('Faltas' = '#1C4F66', 'Agendamentos' = '#3BA9DB'))
```

```{r}
# # GrÃ¡fico com facetas por unidade
# df_abstencoes %>%
#   group_by(Unidade, AnoMÃªs) %>%
#   summarise(
#     Faltas = sum(Faltas, na.rm = TRUE),
#     Agendamentos = sum(Agendamentos, na.rm = TRUE),
#     .groups = 'drop'
#   ) %>%
#   pivot_longer(cols = c(Faltas, Agendamentos), 
#                names_to = "Tipo", 
#                values_to = "Quantidade") %>%
#   ggplot(aes(x = AnoMÃªs, y = Quantidade, group = Tipo, color = Tipo)) +
#   geom_line(size = 1) +
#   facet_wrap(~ Unidade, scales = "free_y") +
#   labs(
#     title = "EvoluÃ§Ã£o de Faltas e Agendamentos por Unidade",
#     x = "MÃªs/Ano",
#     y = "Quantidade"
#   ) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   )
```

No geral, os meses com os maiores nÃºmeros de faltas foram os meses de outubro de 2024, novembro de 2024, agosto de 2024 e dezembro de 2024

```{r}
#| fig-width: 7
#| fig-height: 25
df_hosp = df_absenteismo |> 
  filter(hospital_padronizado !='HOSPITAL DE MESSEJANA' & hospital_padronizado!='HOSPITAL UNIVERSITÃRIO DO CEARÃ') |> 
  group_by(periodo,hospital_padronizado) |> 
  summarise(Faltas = sum(faltas, na.rm = TRUE),
            Agendamentos = sum(agendamentos, na.rm = TRUE),
            TaxaAbsenteismo = (sum(Faltas) / sum(Agendamentos)) * 100,
            .groups = 'drop')

# ðŸ“ˆ contruindo o grafico com os tres indicadores
df_hosp |> 
  pivot_longer(
    cols = c(Faltas, Agendamentos),
    names_to = 'Tipo',
    values_to = 'Quantidade') |> 
  ggplot(aes(x = periodo)) +
  geom_bar(aes(y = Quantidade, fill = Tipo),
           stat = 'identity', position = 'dodge', alpha = 0.8) +
  geom_text(aes(y = Quantidade/2, label = ifelse(Tipo == 'Faltas', Quantidade, ''), 
                group = Tipo),position = position_dodge(width = 0.9),
            color = 'white', size = 3.5, fontface = 'bold',
            show.legend = FALSE) +
  geom_text(aes(y = Quantidade, label = ifelse(Tipo == 'Agendamentos', Quantidade, ''), group = Tipo),
            position = position_dodge(width = 0.9),
            vjust = -0.5, size = 3.5, fontface = 'bold', color = '#3BA9DB',
            show.legend = FALSE) +
  
  # Linha para a taxa de absenteÃ­smo
  geom_line(aes(y = TaxaAbsenteismo * fator_escala, group = 1), 
            color = '#2c5282', size = 1.5, alpha = 0.8) +
  geom_point(aes(y = TaxaAbsenteismo * fator_escala), 
             color = '#2c5282', size = 3) +
  geom_text(aes(y = TaxaAbsenteismo * fator_escala, 
                label = paste0(round(TaxaAbsenteismo, 1), '%')),
            vjust = -1, size = 3.5, color = '#2c5282', fontface = 'bold') +
  scale_y_continuous(
    name = '',
    sec.axis = sec_axis(~ . / fator_escala, 
                        name = '',
                        labels = function(x) paste0(round(x, 2), '%'))
  ) +
  labs(title = '', x = '', fill = '') +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.y.left = element_text(color = 'black'),
    axis.text.y.left = element_text(color = 'black'),
    axis.title.y.right = element_text(color = 'black'),
    axis.text.y.right = element_text(color = 'black'),
    panel.grid.major.y = element_line(color = 'gray80'),
    panel.grid.minor.y = element_blank(),
    legend.position = 'top'
  ) +
  scale_fill_manual(values = c('Faltas' = '#1C4F66', 'Agendamentos' = '#3BA9DB'))+
  facet_wrap(~hospital_padronizado, scales = "free_y",ncol = 2)
```

```{r}
#| fig-width: 15
#| fig-height: 25
# ðŸ“ˆ gerando o grafico com os tres indicadores para cada hospital
hospitais = unique(df_absenteismo$hospital_padronizado)
hospitais = hospitais[hospitais != 'HOSPITAL DE MESSEJANA']

# funcao para criar o grafico para cada hospital
criar_grafico_hospital = function(hospital_nome) {
  
  # filtrar dados para o hospital especifico
  df_hospital = df_absenteismo |> 
    filter(hospital_padronizado == hospital_nome) |> 
    group_by(periodo) |> 
    summarise(
      Faltas = sum(faltas, na.rm = TRUE),
      Agendamentos = sum(agendamentos, na.rm = TRUE),
      TaxaAbsenteismo = ifelse(Agendamentos > 0, (Faltas / Agendamentos) * 100, 0),
      .groups = 'drop'
    )
  
  # calcular fator de escala para este hospital
  max_quantidade = max(df_hospital$Faltas, df_hospital$Agendamentos, na.rm = TRUE)
  if (max_quantidade == 0 || is.infinite(max_quantidade)) {
    fator_escala = 1
  } else {
    fator_escala = max_quantidade / 100
  }
  
  # criar o grÃ¡fico
  p = df_hospital |> 
    pivot_longer(
      cols = c(Faltas, Agendamentos),
      names_to = 'Tipo',
      values_to = 'Quantidade') |> 
    ggplot(aes(x = periodo)) +
    geom_bar(aes(y = Quantidade, fill = Tipo),
             stat = 'identity', position = 'dodge', alpha = 0.8) +
    geom_text(aes(y = Quantidade/2, label = ifelse(Tipo == 'Faltas', Quantidade, ''), 
                  group = Tipo),
              position = position_dodge(width = 0.9),
              color = 'white', size = 3, fontface = 'bold',
              show.legend = FALSE) +
    geom_text(aes(y = Quantidade, label = ifelse(Tipo == 'Agendamentos', Quantidade, ''), 
                  group = Tipo),
              position = position_dodge(width = 0.9),
              vjust = -0.5, size = 3, fontface = 'bold', color = '#3BA9DB',
              show.legend = FALSE) +
    geom_line(aes(y = TaxaAbsenteismo * fator_escala, group = 1), 
              color = '#2c5282', size = 1.5, alpha = 0.8) +
    geom_point(aes(y = TaxaAbsenteismo * fator_escala), 
               color = '#2c5282', size = 3) +
    geom_text(aes(y = TaxaAbsenteismo * fator_escala, 
                  label = paste0(round(TaxaAbsenteismo, 1), '%')),
              vjust = -1, size = 3, color = '#2c5282', fontface = 'bold') +
    scale_y_continuous(
      name = '',
      sec.axis = sec_axis(~ . / fator_escala, 
                          name = '',
                          labels = function(x) paste0(round(x, 1), '%'))
    ) +
    labs(
      title = hospital_nome,
      x = '', 
      fill = ''
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.title.y.left = element_text(color = 'black'),
      axis.text.y.left = element_text(color = 'black'),
      axis.title.y.right = element_text(color = 'black'),
      axis.text.y.right = element_text(color = 'black'),
      panel.grid.major.y = element_line(color = 'gray80'),
      panel.grid.minor.y = element_blank(),
      legend.position = 'top',
      plot.title = element_text(face = 'bold', hjust = 0.5, size = 12)
    ) +
    scale_fill_manual(values = c('Faltas' = '#1C4F66', 'Agendamentos' = '#3BA9DB'))
  
  return(p)
}

plots <- lapply(hospitais, criar_grafico_hospital)

grid.arrange(grobs = plots, ncol = 2)
```
